    <!-- Dark mode support: Code to be added just before end body tag in Theme HTML -->
    <div id='darkModeCode'/>

    <style>
    /* Floating icon button with transparent look */
    #themePromptBtn {
      position: fixed;
      bottom: 4px;
      right: 4px;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.1);
      /* background: rgba(0, 0, 0, 0.25); */
      color: rgba(1, 1, 1, 0.7);
      border: 1px solid rgba(0, 0, 0, 1);
      /* border: 1px solid rgba(255, 255, 255, 0.4); */
      padding: 0px; 
      display: none;
      cursor: pointer;
      text-align: center;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    body.darkmode-optin #themePromptBtn {
      border: 1px solid rgba(255, 255, 255, 1);
    }

    #themePromptBtn svg {
      width: 22px;
      height: 22px;
      stroke: rgba(255, 255, 255, 0.8);
      stroke-width: 1.6;
    }

    /* Split button layout */
    #themePromptBtn.split-btn {
      display: none; /* hidden by default, shown via JS */
      flex-direction: column;
      gap: 0px;
      border-radius: 6px; /* slight rounding */
      overflow: hidden;
    }

    #themePromptBtn.split-btn button {
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.7);
      color: rgba(255,255,255,0.8);
      padding: 0px;
      cursor: pointer;
    }

    body.darkmode-optin #themePromptBtn.split-btn button {
      background: rgba(0,0,0,0);
      color: rgba(255,255,255,0.9);
      border: 1px solid rgba(255,255,255,1);
    }

    @media (min-width: 800px) {
      #themePromptBtn.split-btn button {
        padding: 4px;
      }
      #themePromptBtn svg {
        width: 26px;
        height: 26px;
      }
    }

    #themePromptBtn button:hover {
      background: rgba(0,0,0,0.35);
    }

    .dropdown-content {
      position: fixed;
      bottom: 60px;
      right: 12px;
      background: white;
      color: black;
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      padding: 4px 0;
      z-index: 10001;
    }

    /* make label and tick sit opposite sides */
    .dropdown-content a {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px; 
      text-decoration: none;
      color: inherit;
    }
    .dropdown-content .tick {
      margin-left: 8px;
      opacity: 0.95;
    }

    .dropdown-content a:hover {
      background: rgba(0,0,0,0.1);
    }

    body.darkmode-optin .dropdown-content {
      background: #222;
      color: #eee;
    }
    body.darkmode-optin .dropdown-content a:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    #themeModalOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
    }

    #themeModal {
      position: fixed;
      background: white;
      color: black;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
      max-width: 90%;
    }

    #themeModal button {
      margin: 6px 6px 0 0;
      padding: 6px 10px;
      cursor: pointer;
    }
    </style>

    <!-- Floating button -->
    <!-- Smart split toggle button -->
    <div class='split-btn' id='themePromptBtn'>
      <button id='toggleThemeBtn' title='Toggle Light/Dark'>
        <!-- Sun and Moon SVGs (toggle visibility) -->
        <svg fill='none' id='sunIcon' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
          <circle cx='12' cy='12' r='5' stroke='currentColor' stroke-width='1.6'/>
          <path d='M12 1v2m0 18v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42' stroke='currentColor' stroke-width='1.6'/>
        </svg>
        <svg fill='none' id='moonIcon' style='display:none;' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
          <path d='M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z' stroke='currentColor' stroke-width='1.6'/>
        </svg>
      </button>

      <button id='dropdownBtn' title='Choose Mode ▼'>
        <svg height='12' viewBox='0 0 24 24' width='12' xmlns='http://www.w3.org/2000/svg'>
          <path d='M7 11l5 5 5-5z' fill='currentColor'/>
        </svg>
      </button>

      <div class='dropdown-content' id='modeDropdown' style='display:none;'>
        <a data-mode='light' href='#'>Light</a>
        <a data-mode='dark' href='#'>Dark</a>
        <a data-mode='device' href='#'>Device</a>
      </div>
    </div>

    <!-- Modal -->
    <div id='themeModalOverlay'>
      <div id='themeModal'>
        <p>Please note that the dark mode feature for this blog has some limitations. Some elements of posts may not become dark (e.g., comments).</p>
        <form>
          <p>
            <label for='themeModeSelect'>Appearance Mode:</label><br/>
            <select id='themeModeSelect'>
              <option value='light'>Light</option>
              <option value='dark'>Dark</option>
              <option value='device'>Device (System Default)</option>
            </select>
          </p>
          <p>
            <input id='showIconBtn' type='checkbox'/>
            <label for='showIconBtn'>Show Floating Button</label>
          </p>
          <button id='modalOK' type='button'>OK</button>
          <button id='modalCancel' type='button'>Cancel</button>
        </form>
      </div>
    </div>

    <script>
//<![CDATA[  
    // Default breakpoint for showing floating icon button
    const iconBreakpoint = 800;

    // Default mode is now 'light' (no dark code until user enables)
    let themeMode = localStorage.getItem('themeMode') || 'light';

    // iconBtnVisible can be 'true', 'false', or null (not set)
    // and we treat null as a special case.
    let iconBtnVisible = localStorage.getItem('iconBtnVisible');

    function updateIconVisibility() {
      const btn = document.getElementById('themePromptBtn');
      const w = window.innerWidth;
      if (iconBtnVisible === 'true' || (iconBtnVisible === null && w >= iconBreakpoint)) {
        btn.style.display = 'flex';
      } else {
        btn.style.display = 'none';
      }
    }

    function applyDarkMode() {
      const body = document.body;
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (themeMode === 'dark' || (themeMode === 'device' && prefersDark)) {
        body.classList.add('darkmode-optin');
      } else {
        body.classList.remove('darkmode-optin');
      }
    }

    function openModal(bottomRight = true) {
      const themeModalId = document.getElementById('themeModal');
      document.getElementById('themeModalOverlay').style.display = 'block';

      if (bottomRight) {
        themeModalId.style.top = 'auto';
        themeModalId.style.left = 'auto';
        themeModalId.style.bottom = '20px';
        themeModalId.style.right = '20px';
      } else {
        themeModalId.style.top = '20px';
        themeModalId.style.left = '20px';
        themeModalId.style.bottom = 'auto';
        themeModalId.style.right = 'auto';
      }

      document.getElementById('themeModeSelect').value = themeMode;
      const w = window.innerWidth;
      const showDefault = iconBtnVisible === 'true' || (iconBtnVisible === null && w >= iconBreakpoint);
      document.getElementById('showIconBtn').checked = !!showDefault;
    }

    function closeModal() {
      document.getElementById('themeModalOverlay').style.display = 'none';
    }

    document.getElementById('modalOK').onclick = function () {
      themeMode = document.getElementById('themeModeSelect').value;
      iconBtnVisible = document.getElementById('showIconBtn').checked ? 'true' : 'false';

      localStorage.setItem('themeMode', themeMode);
      localStorage.setItem('iconBtnVisible', iconBtnVisible);

      applyDarkMode();
      updateIconVisibility();
      updateButtonIcons();
      closeModal();
    };

    document.getElementById('modalCancel').onclick = closeModal;

    window.addEventListener('load', () => {
      applyDarkMode();
      updateIconVisibility();
    });

    // Smart split button functionality
    const sunIcon = document.getElementById('sunIcon');
    const moonIcon = document.getElementById('moonIcon');
    const dropdown = document.getElementById('modeDropdown');

    function updateButtonIcons() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = themeMode === 'dark' || (themeMode === 'device' && prefersDark);
      if (isDark) {
        sunIcon.style.display = 'inline';
        moonIcon.style.display = 'none';
      } else {
        sunIcon.style.display = 'none';
        moonIcon.style.display = 'inline';
      }
    }

    // Toggle button click — force toggle between light/dark
    document.getElementById('toggleThemeBtn').onclick = function () {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isCurrentlyDark = document.body.classList.contains('darkmode-optin');
      themeMode = isCurrentlyDark ? 'light' : 'dark';
      localStorage.setItem('themeMode', themeMode);
      applyDarkMode();
      updateButtonIcons();
    };

    // Dropdown open/close — show tick for current selection
    document.getElementById('dropdownBtn').onclick = function (e) {
      e.stopPropagation();
      const isHidden = dropdown.style.display === 'none';
      dropdown.style.display = isHidden ? 'block' : 'none';

      if (isHidden) {
        // update items and add tick to active
        const items = dropdown.querySelectorAll('a[data-mode]');
        items.forEach(item => {
          // preserve original plain label in data-label if not already set
          if (!item.dataset.label) {
            // capture current text without any trailing tick
            item.dataset.label = item.textContent.replace(/\s*✓\s*$/,'').trim();
          }
          // rebuild inner HTML as: label + (tick if selected)
          const label = item.dataset.label;
          if (item.dataset.mode === themeMode) {
            item.innerHTML = `${label}<span class="tick">✓</span>`;
          } else {
            item.innerHTML = label;
          }
        });
      }
    };

    // Dropdown item click
    dropdown.querySelectorAll('a').forEach(a => {
      a.onclick = function (e) {
        e.preventDefault();
        themeMode = this.dataset.mode;
        localStorage.setItem('themeMode', themeMode);
        applyDarkMode();
        updateButtonIcons();
        dropdown.style.display = 'none';
      };
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      dropdown.style.display = 'none';
    });

    // Run on load
    updateButtonIcons();

    window.addEventListener('resize', updateIconVisibility);

    // Auto-update if OS theme changes while in "device" mode
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (themeMode === 'device') {
        applyDarkMode();
        updateButtonIcons();  
      }
    });
//]]>
    </script>
    